<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CellarBook Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; transition: background-color 0.3s ease; }
        .dark { background-color: #0f172a; color: #f8fafc; }
        .dark .bg-white { background-color: #1e293b; border-color: #334155; }
        .dark .text-slate-900 { color: #f1f5f9; }
        .dark .text-slate-600 { color: #94a3b8; }
        .dark .border-slate-200 { border-color: #334155; }
    </style>
</head>
<body class="min-h-screen bg-slate-50">

    <div id="app-container"></div>

    <script>
        // --- Enhanced State Management ---
        let items = JSON.parse(localStorage.getItem('tobacco-cellar-app')) || [];
        let activeTab = 'dashboard';
        let searchQuery = '';
        let selectedItem = null;
        let isEditing = false;
        let darkMode = localStorage.getItem('cellar-dark-mode') === 'true';
        let sortConfig = { key: 'purchaseDate', direction: 'desc' };

        // --- New: Visualizations Logic ---
        const renderCharts = () => {
            const ctx = document.getElementById('brandChart');
            if (!ctx) return;

            const brandCounts = {};
            items.forEach(i => brandCounts[i.brand] = (brandCounts[i.brand] || 0) + i.weightOz);
            
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(brandCounts),
                    datasets: [{
                        data: Object.values(brandCounts),
                        backgroundColor: ['#b45309', '#0369a1', '#047857', '#7e22ce', '#be123c'],
                    }]
                },
                options: { plugins: { legend: { display: false } }, cutout: '70%' }
            });
        };

        // --- New: Delete Logic ---
        const deleteItem = (id) => {
            if(confirm('Are you sure you want to remove this blend from your cellar?')) {
                items = items.filter(i => i.id !== id);
                selectedItem = null;
                saveState();
                renderApp();
            }
        };

        // --- UI Helper for Dark Mode ---
        const toggleDarkMode = () => {
            darkMode = !darkMode;
            localStorage.setItem('cellar-dark-mode', darkMode);
            document.documentElement.classList.toggle('dark', darkMode);
            renderApp();
        };

        // --- Table Sorting Logic ---
        const setSort = (key) => {
            if (sortConfig.key === key) {
                sortConfig.direction = sortConfig.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortConfig.key = key;
                sortConfig.direction = 'asc';
            }
            renderApp();
        };

        const getSortedItems = () => {
            return [...items].sort((a, b) => {
                let valA = a[sortConfig.key];
                let valB = b[sortConfig.key];
                if (sortConfig.key === 'value') {
                    valA = calculateEstValue(a);
                    valB = calculateEstValue(b);
                }
                return sortConfig.direction === 'asc' ? 
                    (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });
        };

        // --- Main Render Function (Add Chart Canvas to Dashboard) ---
        // (Simplified for brevity - ensure this replaces your existing renderDashboard)
        const renderDashboard = () => {
            const stats = getStats();
            return `
                <div class="space-y-6 animate-in slide-in-from-bottom-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${renderStatCard('Wallet', 'Portfolio Value', `$${stats.totalValue.toFixed(2)}`, null, `+$${(stats.totalValue - stats.totalSpent).toFixed(2)} gain`)}
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-slate-500">Brand Mix</p>
                                <h3 class="text-xl font-bold">${Object.keys(items.reduce((acc, i) => ({...acc, [i.brand]:1}), {})).length} Brands</h3>
                            </div>
                            <div class="w-16 h-16"><canvas id="brandChart"></canvas></div>
                        </div>
                        ${renderStatCard('Scale', 'Total Weight', `${(stats.totalWeight / 16).toFixed(2)} lbs`)}
                    </div>
                    </div>
            `;
        };

        // Initialized with Dark Mode check
        window.onload = () => {
            if (darkMode) document.documentElement.classList.add('dark');
            loadState();
            renderApp();
            renderCharts();
        };

        // (Rest of your existing functions like saveState, calculateEstValue, etc.)
    </script>
</body>
</html>
