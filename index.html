<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tobacco Cellar Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">
    <div id="app-container" class="min-h-screen"></div>

    <script>
        // --- Global State ---
        let items = [];
        let activeTab = 'dashboard';
        let searchQuery = '';
        let selectedItem = null;
        let isEditing = false;
        let showReceiptModal = false;
        let showListImportModal = false;
        let pasteText = '';
        let isSyncing = false;
        let syncStatus = 'idle';

        let newItem = {
            type: 'Tin',
            purchaseDate: new Date().toISOString().split('T')[0],
            source: 'Manual',
            brand: '',
            blend: '',
            weightOz: 1.76,
            cost: 0,
            quantity: 1,
            notes: '',
            imageUrl: ''
        };

        const APP_ID = 'tobacco-cellar-app';
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- Core Utilities ---
        const saveState = () => localStorage.setItem(APP_ID, JSON.stringify(items));
        const loadState = () => {
            const stored = localStorage.getItem(APP_ID);
            items = stored ? JSON.parse(stored) : [];
            items.forEach(item => { if(!item.quantity) item.quantity = 1; });
        };

        const calculateEstValue = (item) => {
            const ageInYears = (new Date() - new Date(item.purchaseDate)) / (31536000000);
            let appreciation = 1 + (ageInYears * 0.05);
            if (['McClelland', 'Esoterica', 'Germain'].some(b => item.brand.includes(b))) appreciation += (ageInYears * 0.30);
            return item.cost * appreciation;
        };

        const getStats = () => {
            let totalSpent = 0, totalValue = 0, totalWeight = 0;
            items.forEach(item => {
                totalSpent += (item.cost * item.quantity);
                totalValue += (calculateEstValue(item) * item.quantity);
                totalWeight += (item.weightOz * item.quantity);
            });
            return { totalSpent, totalValue, totalWeight };
        };

        const formatDate = (dateStr) => new Date(dateStr).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        const getAgeString = (dateStr) => {
            const diffDays = Math.ceil((new Date() - new Date(dateStr)) / 86400000); 
            const years = Math.floor(diffDays / 365), months = Math.floor((diffDays % 365) / 30);
            return years > 0 ? `${years}y ${months}m` : `${months}m`;
        };

        const exportToJson = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(items));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "CellarBook_Backup.json"); dl.click();
        };

        // --- View Rendering ---
        const renderIcon = (name, size = 24, className = "") => `<span data-lucide="${name}" data-lucide-size="${size}" class="lucide ${className}" style="width:${size}px; height:${size}px;"></span>`;

        const renderStatCard = (iconName, label, value, subValue, trend) => `
            <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex items-start space-x-4">
                <div class="p-3 bg-slate-100 rounded-lg text-slate-600">${renderIcon(iconName, 24)}</div>
                <div>
                    <p class="text-sm font-medium text-slate-500">${label}</p>
                    <h3 class="text-2xl font-bold text-slate-800">${value}</h3>
                    ${subValue ? `<p class="text-xs text-slate-400 mt-1">${subValue}</p>` : ''}
                </div>
            </div>`;

        const renderDashboard = () => {
            const stats = getStats();
            return `
                <div class="space-y-6 animate-in slide-in-from-bottom-4 duration-300">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${renderStatCard('Wallet', 'Portfolio Value', `$${stats.totalValue.toFixed(2)}`, null)}
                        ${renderStatCard('Scale', 'Total Weight', `${(stats.totalWeight / 16).toFixed(2)} lbs`, `${stats.totalWeight.toFixed(1)} oz`)}
                        ${renderStatCard('TrendingUp', 'Total Investment', `$${stats.totalSpent.toFixed(2)}`, null)}
                    </div>
                    <div class="bg-white p-6 rounded-xl border border-slate-200">
                        <h3 class="font-semibold text-slate-800 mb-4">Cellar Composition (by Weight)</h3>
                        <div class="h-64"><canvas id="brandChart"></canvas></div>
                    </div>
                </div>`;
        };

        const renderInventory = () => {
            const filtered = items.filter(item => item.brand.toLowerCase().includes(searchQuery.toLowerCase()) || item.blend.toLowerCase().includes(searchQuery.toLowerCase()));
            return `
                <div class="space-y-4">
                    <div class="relative">
                        ${renderIcon('Search', 20, 'absolute left-3 top-3 text-slate-400')}
                        <input type="text" placeholder="Search brand or blend..." value="${searchQuery}" oninput="searchQuery=this.value; renderApp()" class="w-full pl-10 pr-4 py-2.5 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-amber-500/20"/>
                    </div>
                    <div class="bg-white rounded-xl border border-slate-200 overflow-hidden">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 border-b">
                                <tr><th class="px-4 py-3 text-xs font-semibold text-slate-500 uppercase">Blend</th><th class="px-4 py-3 text-xs font-semibold text-slate-500 uppercase text-right">Value</th></tr>
                            </thead>
                            <tbody class="divide-y">
                                ${filtered.map(item => `
                                    <tr onclick="selectedItem=items.find(i=>i.id==='${item.id}'); renderApp()" class="hover:bg-amber-50/50 cursor-pointer transition">
                                        <td class="px-4 py-3"><div class="font-medium">${item.blend}</div><div class="text-xs text-slate-500">${item.brand} (Qty: ${item.quantity})</div></td>
                                        <td class="px-4 py-3 text-right"><div class="font-medium text-emerald-600">$${(calculateEstValue(item) * item.quantity).toFixed(2)}</div></td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>`;
        };

        const renderAdd = () => `
            <div class="bg-white rounded-xl border border-slate-200 max-w-xl mx-auto overflow-hidden">
                <div class="bg-slate-50 p-4 border-b"><h2 class="font-bold">Add to Cellar</h2></div>
                <form onsubmit="handleAddItem(event)" class="p-6 space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-medium uppercase text-slate-500">Brand</label><input required class="w-full p-2 border rounded" oninput="newItem.brand=this.value"/></div>
                        <div><label class="text-xs font-medium uppercase text-slate-500">Blend</label><input required class="w-full p-2 border rounded" oninput="newItem.blend=this.value"/></div>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-xs font-medium uppercase text-slate-500">Weight (oz)</label><input type="number" step="0.01" value="1.76" class="w-full p-2 border rounded" oninput="newItem.weightOz=parseFloat(this.value)"/></div>
                        <div><label class="text-xs font-medium uppercase text-slate-500">Cost ($)</label><input type="number" step="0.01" class="w-full p-2 border rounded" oninput="newItem.cost=parseFloat(this.value)"/></div>
                        <div><label class="text-xs font-medium uppercase text-slate-500">Quantity</label><input type="number" value="1" class="w-full p-2 border rounded" oninput="newItem.quantity=parseInt(this.value)"/></div>
                    </div>
                    <div><label class="text-xs font-medium uppercase text-slate-500">Image URL</label><input type="url" placeholder="https://..." class="w-full p-2 border rounded" oninput="newItem.imageUrl=this.value"/></div>
                    <button type="submit" class="w-full py-3 bg-amber-700 text-white font-bold rounded-lg">Add Item</button>
                </form>
            </div>`;

        const renderSync = () => `
            <div class="max-w-xl mx-auto space-y-4">
                <div onclick="exportToJson()" class="p-8 border-2 border-dashed rounded-xl text-center cursor-pointer hover:bg-indigo-50">
                    ${renderIcon('Code', 32, 'mx-auto mb-2 text-indigo-500')}
                    <p class="font-bold">Export JSON Backup</p>
                </div>
                <div class="p-8 border-2 border-dashed rounded-xl text-center text-slate-400">
                    ${renderIcon('RefreshCw', 32, 'mx-auto mb-2')}
                    <p>Other sync features remain unchanged</p>
                </div>
            </div>`;

        const renderDetailModal = () => {
            if (!selectedItem) return '';
            const i = selectedItem;
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="selectedItem=null; renderApp()">
                    <div class="bg-white w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                        <div class="h-32 bg-amber-800 p-6 flex justify-between items-end relative">
                            <div class="text-white z-10"><h2 class="text-2xl font-bold">${i.brand}</h2><p>${i.blend}</p></div>
                            <div class="absolute top-4 right-4 space-x-2">
                                <button onclick="items=items.filter(it=>it.id!=='${i.id}'); selectedItem=null; saveState(); renderApp()" class="text-white/50 hover:text-red-400">${renderIcon('Trash2', 20)}</button>
                                <button onclick="selectedItem=null; renderApp()" class="text-white/50 hover:text-white">${renderIcon('X', 20)}</button>
                            </div>
                        </div>
                        <div class="p-6 space-y-4">
                            ${i.imageUrl ? `<img src="${i.imageUrl}" class="w-full h-48 object-cover rounded-lg border">` : ''}
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-slate-50 rounded border"><p class="text-xs uppercase text-slate-500">Value</p><p class="text-xl font-bold text-emerald-600">$${(calculateEstValue(i) * i.quantity).toFixed(2)}</p></div>
                                <div class="p-3 bg-slate-50 rounded border"><p class="text-xs uppercase text-slate-500">Age</p><p class="text-xl font-bold">${getAgeString(i.purchaseDate)}</p></div>
                            </div>
                            <p class="text-sm text-slate-600"><strong>Quantity:</strong> ${i.quantity} â€¢ <strong>Paid:</strong> $${i.cost} each</p>
                        </div>
                    </div>
                </div>`;
        };

        const renderApp = () => {
            const app = document.getElementById('app-container');
            const navItems = [
                { tab: 'dashboard', label: 'Dashboard', icon: 'PieChart' },
                { tab: 'inventory', label: 'Inventory', icon: 'Wallet' },
                { tab: 'add', label: 'Add', icon: 'Plus' },
                { tab: 'sync', label: 'Sync', icon: 'RefreshCw' },
            ];

            app.innerHTML = `
                <div class="min-h-screen bg-slate-50 text-slate-900 pb-20 md:pb-0">
                    <header class="bg-white border-b sticky top-0 z-10 p-4 shadow-sm">
                        <div class="max-w-4xl mx-auto flex justify-between items-center">
                            <div class="flex items-center space-x-2">
                                <div class="bg-amber-700 text-white p-2 rounded-lg">${renderIcon('PieChart', 20)}</div>
                                <div><h1 class="text-xl font-bold">Cellar<span class="text-amber-700">Book</span></h1></div>
                            </div>
                        </div>
                    </header>
                    <div class="hidden md:flex max-w-4xl mx-auto px-6 pt-4 space-x-6 border-b">
                        ${navItems.map(n => `<button onclick="activeTab='${n.tab}'; renderApp()" class="pb-3 px-1 border-b-2 font-semibold text-sm ${activeTab===n.tab?'border-amber-700 text-amber-700':'border-transparent text-slate-500'}">${n.label}</button>`).join('')}
                    </div>
                    <main class="max-w-4xl mx-auto p-4 md:p-6">
                        ${activeTab === 'dashboard' ? renderDashboard() : activeTab === 'inventory' ? renderInventory() : activeTab === 'add' ? renderAdd() : renderSync()}
                    </main>
                    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t md:hidden z-20">
                        <div class="flex justify-around h-16">
                            ${navItems.map(n => `<button onclick="activeTab='${n.tab}'; renderApp()" class="flex flex-col items-center justify-center p-2 ${activeTab===n.tab?'text-amber-700':'text-slate-500'}">${renderIcon(n.icon, 24)}<span class="text-[10px] mt-1 font-medium">${n.label}</span></button>`).join('')}
                        </div>
                    </nav>
                </div>
                ${renderDetailModal()}`;
            lucide.createIcons();
            if (activeTab === 'dashboard') initCharts();
        };

        const handleAddItem = (e) => {
            e.preventDefault();
            const existing = items.find(i => i.brand.toLowerCase() === newItem.brand.toLowerCase() && i.blend.toLowerCase() === newItem.blend.toLowerCase());
            if (existing) {
                existing.quantity += newItem.quantity;
            } else {
                items.unshift({ ...newItem, id: generateId() });
            }
            newItem = { type: 'Tin', purchaseDate: new Date().toISOString().split('T')[0], source: 'Manual', brand: '', blend: '', weightOz: 1.76, cost: 0, quantity: 1, notes: '', imageUrl: '' };
            activeTab = 'inventory';
            saveState(); renderApp();
        };

        const initCharts = () => {
            const ctx = document.getElementById('brandChart');
            if (!ctx || items.length === 0) return;
            const brands = {};
            items.forEach(i => brands[i.brand] = (brands[i.brand] || 0) + (i.weightOz * i.quantity));
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(brands),
                    datasets: [{ data: Object.values(brands), backgroundColor: ['#b45309', '#d97706', '#f59e0b', '#fbbf24', '#78350f'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        };

        window.onload = () => { loadState(); renderApp(); };
    </script>
</body>
</html>
