<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CellarBook - Tobacco Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen pb-20 md:pb-0">

    <div id="app-container"></div>

    <script>
        // --- State Management ---
        let items = [];
        let activeTab = 'dashboard';
        let searchQuery = '';
        let selectedItem = null;
        let isEditing = false;
        let showReceiptModal = false;
        let showListImportModal = false;
        let pasteText = '';
        let isSyncing = false;
        let syncStatus = 'idle';

        let newItem = {
            type: 'Tin',
            purchaseDate: new Date().toISOString().split('T')[0],
            brand: '',
            blend: '',
            weightOz: 1.76,
            cost: 0,
            quantity: 1,
            notes: '',
            imageUrl: ''
        };

        const APP_ID = 'tobacco-cellar-app';
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // --- Core Utilities ---
        const saveState = () => localStorage.setItem(APP_ID, JSON.stringify(items));
        
        const loadState = () => {
            const stored = localStorage.getItem(APP_ID);
            items = stored ? JSON.parse(stored) : [];
            items.forEach(item => { if(!item.quantity) item.quantity = 1; });
        };

        const calculateEstValue = (item) => {
            const ageInYears = (new Date() - new Date(item.purchaseDate)) / (1000 * 60 * 60 * 24 * 365);
            let appreciation = 1 + (ageInYears * 0.05);
            if (['McClelland', 'Esoterica', 'Germain'].some(b => item.brand.includes(b))) appreciation += (ageInYears * 0.30);
            return item.cost * appreciation;
        };

        const getStats = () => {
            let totalSpent = 0, totalValue = 0, totalWeight = 0;
            items.forEach(item => {
                totalSpent += (item.cost * item.quantity);
                totalValue += (calculateEstValue(item) * item.quantity);
                totalWeight += (item.weightOz * item.quantity);
            });
            return { totalSpent, totalValue, totalWeight };
        };

        const getAgeString = (dateStr) => {
            const diff = Math.ceil((new Date() - new Date(dateStr)) / (1000 * 60 * 60 * 24));
            const y = Math.floor(diff / 365), m = Math.floor((diff % 365) / 30);
            return y > 0 ? `${y}y ${m}m` : `${m}m`;
        };

        // --- Handlers ---
        const handleAddItem = (e) => {
            e.preventDefault();
            const existing = items.find(i => i.brand.toLowerCase() === newItem.brand.toLowerCase() && i.blend.toLowerCase() === newItem.blend.toLowerCase());
            if (existing) {
                existing.quantity += parseInt(newItem.quantity);
                existing.notes += `\n[Added ${newItem.quantity} on ${new Date().toLocaleDateString()}]`;
            } else {
                items.unshift({ ...newItem, id: generateId() });
            }
            newItem = { type: 'Tin', purchaseDate: new Date().toISOString().split('T')[0], brand: '', blend: '', weightOz: 1.76, cost: 0, quantity: 1, notes: '', imageUrl: '' };
            activeTab = 'inventory';
            saveState(); renderApp();
        };

        const deleteItem = (id) => {
            if (confirm("Delete this item?")) {
                items = items.filter(i => i.id !== id);
                selectedItem = null;
                saveState(); renderApp();
            }
        };

        const exportToJson = () => {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(items));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "CellarBook_Backup.json"); dl.click();
        };

        const renderIcon = (name, size = 24, className = "") => `<span data-lucide="${name}" data-lucide-size="${size}" class="${className}"></span>`;

        // --- View Components ---
        const renderDashboard = () => {
            const stats = getStats();
            return `
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-white p-5 rounded-xl border">
                            <p class="text-sm text-slate-500">Portfolio Value</p>
                            <h3 class="text-2xl font-bold text-emerald-600">$${stats.totalValue.toFixed(2)}</h3>
                        </div>
                        <div class="bg-white p-5 rounded-xl border">
                            <p class="text-sm text-slate-500">Total Weight</p>
                            <h3 class="text-2xl font-bold text-slate-800">${(stats.totalWeight / 16).toFixed(2)} lbs</h3>
                        </div>
                        <div class="bg-white p-5 rounded-xl border">
                            <p class="text-sm text-slate-500">Total Investment</p>
                            <h3 class="text-2xl font-bold text-slate-800">$${stats.totalSpent.toFixed(2)}</h3>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl border">
                        <h3 class="font-semibold mb-4 text-slate-800">Brand Distribution</h3>
                        <div class="h-64"><canvas id="brandChart"></canvas></div>
                    </div>
                </div>
            `;
        };

        const initCharts = () => {
            const ctx = document.getElementById('brandChart');
            if (!ctx || items.length === 0) return;
            const dataMap = {};
            items.forEach(i => dataMap[i.brand] = (dataMap[i.brand] || 0) + (i.weightOz * i.quantity));
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{ data: Object.values(dataMap), backgroundColor: ['#b45309', '#d97706', '#f59e0b', '#fbbf24', '#78350f'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        };

        const renderDetailModal = () => {
            if (!selectedItem) return '';
            const i = selectedItem;
            return `
                <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="selectedItem=null; renderApp()">
                    <div class="bg-white w-full max-w-lg rounded-2xl overflow-hidden shadow-2xl" onclick="event.stopPropagation()">
                        <div class="h-32 bg-amber-800 p-6 flex justify-between items-end relative">
                            <div class="text-white"><h2 class="text-2xl font-bold">${i.brand}</h2><p>${i.blend}</p></div>
                            <button onclick="deleteItem('${i.id}')" class="text-white/50 hover:text-red-400 absolute top-4 right-12">${renderIcon('Trash2', 20)}</button>
                            <button onclick="selectedItem=null; renderApp()" class="text-white/50 hover:text-white absolute top-4 right-4">${renderIcon('X', 20)}</button>
                        </div>
                        <div class="p-6 space-y-4">
                            ${i.imageUrl ? `<img src="${i.imageUrl}" class="w-full h-40 object-cover rounded-lg border">` : ''}
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-slate-50 rounded border"><p class="text-xs uppercase text-slate-500">Quantity</p><p class="text-xl font-bold">${i.quantity}</p></div>
                                <div class="p-3 bg-slate-50 rounded border"><p class="text-xs uppercase text-slate-500">Market Value</p><p class="text-xl font-bold text-emerald-600">$${(calculateEstValue(i) * i.quantity).toFixed(2)}</p></div>
                            </div>
                            <button onclick="selectedItem=null; renderApp()" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold">Close</button>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderApp = () => {
            const container = document.getElementById('app-container');
            container.innerHTML = `
                <header class="bg-white border-b p-4 sticky top-0 z-10">
                    <div class="max-w-4xl mx-auto flex justify-between items-center">
                        <h1 class="text-xl font-bold">Cellar<span class="text-amber-700">Book</span></h1>
                        <nav class="hidden md:flex space-x-4">
                            <button onclick="activeTab='dashboard'; renderApp()" class="${activeTab==='dashboard'?'text-amber-700 font-bold':''}">Dashboard</button>
                            <button onclick="activeTab='inventory'; renderApp()" class="${activeTab==='inventory'?'text-amber-700 font-bold':''}">Inventory</button>
                            <button onclick="activeTab='add'; renderApp()" class="${activeTab==='add'?'text-amber-700 font-bold':''}">Add</button>
                            <button onclick="activeTab='sync'; renderApp()" class="${activeTab==='sync'?'text-amber-700 font-bold':''}">Sync</button>
                        </nav>
                    </div>
                </header>
                <main class="max-w-4xl mx-auto p-4">${activeTab === 'dashboard' ? renderDashboard() : activeTab === 'inventory' ? '<p class="text-center py-10">Inventory List Here...</p>' : activeTab === 'add' ? '<p class="text-center py-10">Add Form Here...</p>' : '<button onclick="exportToJson()" class="w-full p-4 border-2 border-dashed">Export JSON</button>'}</main>
                ${renderDetailModal()}
            `;
            lucide.createIcons();
            if (activeTab === 'dashboard') initCharts();
        };

        window.onload = () => { loadState(); renderApp(); };
    </script>
</body>
</html>
